// Temporary worker code with domain allowlist for jaretaparo.com and subdomains
// Safe to delete after copying into your Cloudflare Worker dashboard.

const ALLOWED_HOSTNAMES = ["jaretaparo.com"];

function isAllowedOrigin(originValue = "") {
  try {
    const { hostname, origin } = new URL(originValue);
    if (hostname === "jaretaparo.com" || hostname.endsWith(".jaretaparo.com")) {
      return origin;
    }
  } catch (_) {}
  return null;
}

function buildCorsHeaders(origin) {
  const headers = {
    "Access-Control-Allow-Methods": "GET, POST, OPTIONS",
    "Access-Control-Allow-Headers": "Content-Type",
    "Content-Type": "application/json",
    "Vary": "Origin",
  };
  if (origin) headers["Access-Control-Allow-Origin"] = origin;
  return headers;
}

export default {
  async fetch(request, env) {
    const originHeader = request.headers.get("Origin") || "";
    const allowedOrigin = isAllowedOrigin(originHeader);
    const corsHeaders = buildCorsHeaders(allowedOrigin);

    // Reject unknown origins
    if (request.method !== "OPTIONS" && !allowedOrigin) {
      return new Response(JSON.stringify({ error: "Forbidden origin" }), { status: 403, headers: corsHeaders });
    }

    // Handle CORS preflight
    if (request.method === "OPTIONS") {
      return new Response(null, { status: 204, headers: corsHeaders });
    }

    // Optional: also enforce host header if using a custom worker domain
    const host = request.headers.get("Host") || "";
    const hostAllowed = ALLOWED_HOSTNAMES.some((h) => host === h || host.endsWith(`.${h}`));
    if (!hostAllowed) {
      return new Response(JSON.stringify({ error: "Forbidden host" }), { status: 403, headers: corsHeaders });
    }

    const apiKey = env.OPENAI_API_KEY;
    if (!apiKey) {
      return new Response(JSON.stringify({ error: "Missing OPENAI_API_KEY" }), { status: 500, headers: corsHeaders });
    }

    const apiUrl = "https://api.openai.com/v1/chat/completions";
    const userInput = await request.json();

    const requestBody = {
      model: "gpt-4o",
      messages: userInput.messages ?? [],
      max_tokens: 300,
    };

    const response = await fetch(apiUrl, {
      method: "POST",
      headers: {
        Authorization: `Bearer ${apiKey}`,
        "Content-Type": "application/json",
      },
      body: JSON.stringify(requestBody),
    });

    const raw = await response.text();
    let data;
    try {
      data = JSON.parse(raw);
    } catch (_) {
      data = { error: { message: raw || "Unknown error from OpenAI." } };
    }

    const status = response.ok ? 200 : response.status;
    return new Response(JSON.stringify(data), { status, headers: corsHeaders });
  },
};
